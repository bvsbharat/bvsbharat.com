---
import { SITE } from "@/config";
import { NAVIGATION } from "@/consts";
import Hr from "./Hr.astro";

const { pathname } = Astro.url;
const currentPath = pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter((p) => p.trim());
  const pathArray = path.split("/").filter((p) => p.trim());
  return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<header>
  <a
    id="skip-to-content"
    href="#main-content"
    class="skip-to-content"
  >
    Skip to content
  </a>
  <div class="mx-auto flex flex-col items-center justify-between sm:flex-row" style="max-width:1020px">
    <div class="relative flex w-full items-baseline justify-between bg-background p-2 sm:items-center sm:py-3">
      <a
        href="/"
        class="absolute py-1 sm:static hover:text-accent transition-colors"
      >
        <span class="text-2xl leading-7 font-semibold whitespace-nowrap">{SITE.author}</span>
        <span class="flex items-center gap-1 text-xs text-gray-400 dark:text-gray-500 font-normal">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          San Francisco, CA, USA
        </span>
      </a>
      <nav
        id="nav-menu"
        class="flex w-full flex-col items-center sm:ml-2 sm:flex-row sm:justify-end sm:space-x-4 sm:py-0"
      >
        <div class="flex items-center gap-1 self-end sm:hidden">
          <button
            id="mobile-theme-btn"
            class="relative size-10 p-2 hover:[&>svg]:stroke-accent"
            title="Toggle light & dark"
            aria-label="Toggle theme"
          >
            <svg id="mobile-moon-icon" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-100 rotate-0 transition-all" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
            <svg id="mobile-sun-icon" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-0 rotate-90 transition-all" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
          </button>
          <button
            id="menu-btn"
            class="p-2"
            aria-label="Open Menu"
            aria-expanded="false"
            aria-controls="menu-items"
          >
          <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
          <svg id="close-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
        </div>
        <ul
          id="menu-items"
          class="mt-4 hidden grid w-44 grid-cols-2 place-content-center gap-2 sm:mt-0 sm:ml-0 sm:flex sm:w-auto sm:gap-x-5 sm:gap-y-0 [&>li>a]:block [&>li>a]:px-4 [&>li>a]:py-3 [&>li>a]:text-center [&>li>a]:font-medium [&>li>a]:hover:text-accent [&>li>a]:transition-colors [&>li>a]:duration-200 sm:[&>li>a]:px-2 sm:[&>li>a]:py-1"
        >
          {NAVIGATION.map(({ name, href }) => (
            <li class="col-span-2">
              <a
                href={href}
                class:list={[{ "active-nav": isActive(href) }]}
              >
                {name === "Hackathons" ? <span class="inline-flex items-center gap-1">{name}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg></span> : name}
              </a>
            </li>
          ))}
          <li class="col-span-1 flex items-center justify-center">
            <a
              href="/search"
              class:list={[
                "block px-4 py-3 sm:px-2 sm:py-1",
                { "active-nav": isActive("/search") },
              ]}
              aria-label="Search"
              title="Search"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
              <span class="sr-only">Search</span>
            </a>
          </li>
          <li class="col-span-1 flex items-center justify-center">
            <button
              id="theme-btn"
              class="relative size-12 p-4 sm:size-8 hover:[&>svg]:stroke-accent"
              title="Toggle light & dark"
              aria-label="Toggle theme"
            >
              <svg id="moon-icon" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-100 rotate-0 transition-all" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
              <svg id="sun-icon" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-0 rotate-90 transition-all" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <Hr />
</header>

<script>
  function setupHeader() {
    // Mobile menu toggle
    const menuBtn = document.getElementById("menu-btn");
    const menuItems = document.getElementById("menu-items");
    const menuIcon = document.getElementById("menu-icon");
    const closeIcon = document.getElementById("close-icon");

    menuBtn?.addEventListener("click", () => {
      const isOpen = menuBtn.getAttribute("aria-expanded") === "true";
      menuBtn.setAttribute("aria-expanded", isOpen ? "false" : "true");
      menuBtn.setAttribute("aria-label", isOpen ? "Open Menu" : "Close Menu");
      menuItems?.classList.toggle("hidden");
      menuIcon?.classList.toggle("hidden");
      closeIcon?.classList.toggle("hidden");
    });

    // Theme toggle
    const themeBtn = document.getElementById("theme-btn");
    const mobileThemeBtn = document.getElementById("mobile-theme-btn");
    const moonIcon = document.getElementById("moon-icon");
    const sunIcon = document.getElementById("sun-icon");
    const mobileMoonIcon = document.getElementById("mobile-moon-icon");
    const mobileSunIcon = document.getElementById("mobile-sun-icon");

    function updateThemeIcons() {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      const moons = [moonIcon, mobileMoonIcon];
      const suns = [sunIcon, mobileSunIcon];
      if (isDark) {
        moons.forEach(el => { el?.classList.add("scale-0", "rotate-90"); el?.classList.remove("scale-100", "rotate-0"); });
        suns.forEach(el => { el?.classList.add("scale-100", "rotate-0"); el?.classList.remove("scale-0", "rotate-90"); });
      } else {
        moons.forEach(el => { el?.classList.add("scale-100", "rotate-0"); el?.classList.remove("scale-0", "rotate-90"); });
        suns.forEach(el => { el?.classList.add("scale-0", "rotate-90"); el?.classList.remove("scale-100", "rotate-0"); });
      }
    }

    updateThemeIcons();

    function toggleTheme() {
      const setTheme = () => {
        const isDark = document.documentElement.getAttribute("data-theme") === "dark";
        const newTheme = isDark ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcons();
      };
      if (document.startViewTransition) {
        document.startViewTransition(setTheme);
      } else {
        setTheme();
      }
    }

    themeBtn?.addEventListener("click", toggleTheme);
    mobileThemeBtn?.addEventListener("click", toggleTheme);
  }

  setupHeader();
  document.addEventListener("astro:after-swap", setupHeader);
</script>
